# 大拇哥积分商城 - 项目架构说明

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                              │
│                    http://localhost:5173                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP Request
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   Vue3 前端 (Vite)                            │
│  ┌──────────────┬──────────────┬──────────────────────┐    │
│  │  登录页面     │  用户界面      │    管理员界面         │    │
│  ├──────────────┼──────────────┼──────────────────────┤    │
│  │  Dashboard   │  积分商城      │    用户管理           │    │
│  │  我的积分     │  兑换记录      │    发放大拇哥         │    │
│  │              │               │    商品管理           │    │
│  │              │               │    兑换管理           │    │
│  └──────────────┴──────────────┴──────────────────────┘    │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ AJAX Request (/api/*)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   Flask 后端 API                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  认证模块 (JWT)                                        │  │
│  │  ├─ 登录                                              │  │
│  │  └─ 获取用户信息                                       │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  用户管理                                              │  │
│  │  ├─ 创建/编辑/查询用户                                 │  │
│  │  └─ 权限控制                                          │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  大拇哥管理                                            │  │
│  │  ├─ 发放大拇哥（单/双）                                │  │
│  │  ├─ 查询记录                                          │  │
│  │  └─ 统计数据                                          │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  商品管理                                              │  │
│  │  ├─ CRUD 操作                                         │  │
│  │  └─ 上下架管理                                        │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  兑换管理                                              │  │
│  │  ├─ 创建兑换                                          │  │
│  │  ├─ 取消兑换                                          │  │
│  │  └─ 查询记录                                          │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ SQL Query
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                     MySQL 数据库                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  users (用户表)                                       │   │
│  │  ├─ 基本信息                                         │   │
│  │  ├─ 总积分 / 可用积分                                 │   │
│  │  └─ 角色（admin/user）                               │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  thumbs_records (大拇哥记录表)                        │   │
│  │  ├─ 类型（单/双）                                     │   │
│  │  ├─ 积分数                                           │   │
│  │  ├─ 原因                                             │   │
│  │  └─ 发放人                                           │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  products (商品表)                                    │   │
│  │  ├─ 商品信息                                         │   │
│  │  ├─ 所需积分                                         │   │
│  │  ├─ 库存                                             │   │
│  │  └─ 上下架状态                                       │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  exchange_records (兑换记录表)                        │   │
│  │  ├─ 用户/商品                                        │   │
│  │  ├─ 消耗积分                                         │   │
│  │  └─ 兑换状态                                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、核心业务流程

### 1. 发放大拇哥流程

```
管理员选择用户
    ↓
选择类型（单👍或双👍👍）
    ↓
填写获得原因
    ↓
提交 → 后端验证权限
    ↓
创建 thumbs_record 记录
    ↓
更新用户 total_points 和 available_points
    ↓
返回成功 → 前端刷新列表
```

### 2. 商品兑换流程

```
用户浏览商品列表
    ↓
选择商品点击兑换
    ↓
确认兑换弹窗
    ↓
提交 → 后端验证
    ├─ 检查商品是否上架
    ├─ 检查库存是否充足
    └─ 检查用户积分是否足够
    ↓
创建 exchange_record 记录
    ├─ 扣除用户 available_points
    └─ 减少商品 stock
    ↓
返回成功 → 前端刷新
```

### 3. 商品上下架流程

```
管理员编辑商品
    ↓
切换状态（上架/下架）
    ↓
提交 → 更新 products.status
    ↓
返回成功
    ├─ 上架：商品在商城中显示
    └─ 下架：商品在商城中隐藏
```

---

## 三、技术选型说明

### 前端技术栈
- **Vue 3**: 渐进式 JavaScript 框架
- **Vite**: 快速的前端构建工具
- **Element Plus**: 基于 Vue 3 的 UI 组件库
- **Pinia**: Vue 3 官方推荐的状态管理库
- **Vue Router**: 官方路由管理器
- **Axios**: HTTP 请求库

### 后端技术栈
- **Flask**: 轻量级 Python Web 框架
- **SQLAlchemy**: Python ORM 库
- **Flask-JWT-Extended**: JWT 认证扩展
- **PyMySQL**: MySQL 数据库驱动
- **Flask-CORS**: 跨域支持

### 数据库
- **MySQL 8.0**: 关系型数据库
- 使用 InnoDB 引擎
- UTF8MB4 字符集

---

## 四、目录结构详解

```
.
├── backend/                    # 后端代码目录
│   ├── app.py                 # Flask 应用主入口，包含所有 API 路由
│   ├── models.py              # SQLAlchemy 数据模型定义
│   ├── config.py              # 配置文件（数据库、JWT等）
│   ├── requirements.txt       # Python 依赖包列表
│   ├── API.md                 # API 接口文档
│   └── .gitignore            # Git 忽略文件
│
├── frontend/                   # 前端代码目录
│   ├── src/
│   │   ├── main.js           # Vue 应用入口
│   │   ├── App.vue           # 根组件
│   │   ├── router/           # 路由配置
│   │   │   └── index.js      # 路由定义和守卫
│   │   ├── stores/           # Pinia 状态管理
│   │   │   └── user.js       # 用户状态（登录、token等）
│   │   ├── utils/            # 工具函数
│   │   │   └── api.js        # Axios 封装和拦截器
│   │   ├── views/            # 页面组件
│   │   │   ├── Login.vue     # 登录页
│   │   │   ├── Dashboard.vue # 首页仪表板
│   │   │   ├── Mall.vue      # 积分商城
│   │   │   ├── MyPoints.vue  # 我的积分
│   │   │   ├── MyExchanges.vue # 兑换记录
│   │   │   └── admin/        # 管理员页面
│   │   │       ├── Users.vue     # 用户管理
│   │   │       ├── Thumbs.vue    # 发放大拇哥
│   │   │       ├── Products.vue  # 商品管理
│   │   │       └── Exchanges.vue # 兑换管理
│   │   └── layouts/          # 布局组件
│   │       └── MainLayout.vue # 主布局（侧边栏+导航）
│   ├── index.html            # HTML 入口
│   ├── package.json          # Node 依赖配置
│   ├── vite.config.js        # Vite 配置（代理等）
│   └── .gitignore           # Git 忽略文件
│
├── database/                  # 数据库脚本
│   └── init.sql              # 初始化脚本（建表+测试数据）
│
├── README.md                 # 项目说明
├── DEPLOY.md                 # 部署文档
├── 快速启动指南.md            # 快速上手教程
├── 项目架构说明.md            # 本文档
└── .gitignore               # 全局 Git 忽略文件
```

---

## 五、核心功能模块

### 1. 认证授权
- JWT Token 认证
- 角色权限控制（admin/user）
- 路由守卫（前端 + 后端双重验证）

### 2. 积分系统
- 单大拇哥：1 积分 👍
- 双大拇哥：5 积分 👍👍
- 积分记录可追溯
- 积分统计展示

### 3. 商城系统
- 商品 CRUD 管理
- 商品上下架控制
- 库存管理
- 积分兑换

### 4. 兑换系统
- 积分扣除
- 库存扣减
- 兑换记录
- 取消兑换（退回积分和库存）

### 5. 用户系统
- 用户管理
- 权限分配
- 积分查询

---

## 六、安全特性

1. **密码加密**: 使用 Werkzeug 的 `generate_password_hash` 加密存储
2. **JWT 认证**: Token 有效期 24 小时
3. **权限验证**: 管理员操作需要验证角色
4. **CORS 配置**: 只允许配置的前端域名访问
5. **SQL 注入防护**: 使用 ORM 防止 SQL 注入
6. **XSS 防护**: 前端使用 Vue 的模板语法自动转义

---

## 七、扩展建议

如果未来需要扩展功能，可以考虑：

1. **用户头像上传**: 添加文件上传功能
2. **消息通知**: 获得大拇哥时推送通知
3. **积分排行榜**: 展示积分排名
4. **商品分类**: 添加商品分类管理
5. **兑换审核流程**: 兑换需要管理员审核
6. **数据导出**: 导出统计报表
7. **移动端适配**: 响应式设计优化
8. **微信登录**: 集成企业微信扫码登录
9. **积分过期机制**: 定期清理过期积分
10. **操作日志**: 记录重要操作的审计日志

---

## 八、性能优化建议

1. **数据库索引**: 已在关键字段添加索引
2. **分页查询**: 所有列表接口都支持分页
3. **前端缓存**: 使用 Pinia 缓存用户信息
4. **静态资源**: 生产环境使用 CDN
5. **数据库连接池**: SQLAlchemy 自带连接池
6. **API 响应压缩**: 可配置 gzip 压缩

---

## 九、开发规范

### 命名规范
- **后端**: 
  - 文件名: `snake_case`
  - 类名: `PascalCase`
  - 函数名: `snake_case`
  
- **前端**:
  - 文件名: `PascalCase.vue` (组件)
  - 函数名: `camelCase`
  - 常量名: `UPPER_SNAKE_CASE`

### 提交规范
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具相关

---

## 十、常见问题排查

### 数据库问题
```bash
# 查看数据库状态
systemctl status mysql

# 查看数据库日志
tail -f /var/log/mysql/error.log
```

### 后端问题
```bash
# 查看 Flask 日志
# 直接在控制台输出

# 测试数据库连接
python -c "from app import db; print(db.engine)"
```

### 前端问题
```bash
# 清除缓存重新安装
rm -rf node_modules package-lock.json
npm install

# 查看构建产物
npm run build
```

---

完整的项目架构清晰、易于维护和扩展，适合内网快速部署使用！

